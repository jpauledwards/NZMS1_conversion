library(tidyverse)
library(sf)

#Projections
NIYG  <- "+proj=tmerc +lat_0=-39 +lon_0=175.5 +k=1.0000017338 +x_0=274320 +y_0=365760 +ellps=intl +units=yd +datum=nzgd49 +no_defs"
SIYG  <- "+proj=tmerc +lat_0=-44 +lon_0=171.5 +k=1.0000017338 +x_0=457200 +y_0=457200 +ellps=intl +units=yd +datum=nzgd49 +no_defs"
WGS84 <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
NZTM  <- "+proj=tmerc +lat_0=0 +lon_0=173 +k=0.9996 +x_0=1600000 +y_0=10000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"

#Load data
MapRefCoords <- read.csv("InputCoords.csv")

#Map sheet references
MapSheets <- tribble(~Sheet, ~SheetNorth, ~SheetEast,
                     'N001',940000,-15000,
                     'N002',940000,30000,
                     'N003',910000,-15000,
                     'N004',910000,30000,
                     'N005',910000,75000,
                     'N006',880000,30000,
                     'N007',880000,75000,
                     'N008',880000,120000,
                     'N009',850000,30000,
                     'N010',850000,75000,
                     'N011',850000,120000,
                     'N012',850000,165000,
                     'N013',820000,30000,
                     'N014',820000,75000,
                     'N015',820000,120000,
                     'N016',820000,165000,
                     'N017',820000,210000,
                     'N018',790000,75000,
                     'N019',790000,120000,
                     'N020',790000,165000,
                     'N021',790000,210000,
                     'N022',760000,75000,
                     'N023',760000,120000,
                     'N024',760000,165000,
                     'N025',760000,210000,
                     'N026',760000,255000,
                     'N027',730000,120000,
                     'N028',730000,165000,
                     'N029',730000,210000,
                     'N030',730000,255000,
                     'N031',730000,300000,
                     'N032',700000,120000,
                     'N033',700000,165000,
                     'N034',700000,210000,
                     'N035',700000,255000,
                     'N036',700000,300000,
                     'N037',670000,165000,
                     'N038',670000,210000,
                     'N039',670000,255000,
                     'N040',670000,300000,
                     'N041',640000,165000,
                     'N042',640000,210000,
                     'N043',640000,255000,
                     'N044',640000,300000,
                     'N045',640000,345000,
                     'N046',610000,165000,
                     'N047',610000,210000,
                     'N048',610000,255000,
                     'N049',610000,300000,
                     'N050',610000,345000,
                     'N051',580000,210000,
                     'N052',580000,255000,
                     'N053',580000,300000,
                     'N054',580000,345000,
                     'N055',550000,210000,
                     'N056',550000,255000,
                     'N057',550000,300000,
                     'N058',550000,345000,
                     'N059',550000,390000,
                     'N060',550000,435000,
                     'N061',550000,480000,
                     'N062',550000,525000,
                     'N063',550000,570000,
                     'N064',520000,210000,
                     'N065',520000,255000,
                     'N066',520000,300000,
                     'N067',520000,345000,
                     'N068',520000,390000,
                     'N069',520000,435000,
                     'N070',520000,480000,
                     'N071',520000,525000,
                     'N072',520000,570000,
                     'N073',490000,210000,
                     'N074',490000,255000,
                     'N075',490000,300000,
                     'N076',490000,345000,
                     'N077',490000,390000,
                     'N078',490000,435000,
                     'N079',490000,480000,
                     'N080',490000,525000,
                     'N081',490000,570000,
                     'N082',460000,210000,
                     'N083',460000,255000,
                     'N084',460000,300000,
                     'N085',460000,345000,
                     'N086',460000,390000,
                     'N087',460000,435000,
                     'N088',460000,480000,
                     'N089',460000,525000,
                     'N090',460000,570000,
                     'N091',430000,210000,
                     'N092',430000,255000,
                     'N093',430000,300000,
                     'N094',430000,345000,
                     'N095',430000,390000,
                     'N096',430000,435000,
                     'N097',430000,480000,
                     'N098',430000,525000,
                     'N099',400000,165000,
                     'N100',400000,210000,
                     'N101',400000,255000,
                     'N102',400000,300000,
                     'N103',400000,345000,
                     'N104',400000,390000,
                     'N105',400000,435000,
                     'N106',400000,480000,
                     'N107',400000,525000,
                     'N108',370000,120000,
                     'N109',370000,165000,
                     'N110',370000,210000,
                     'N111',370000,255000,
                     'N112',370000,300000,
                     'N113',370000,345000,
                     'N114',370000,390000,
                     'N115',370000,435000,
                     'N116',370000,480000,
                     'N117',370000,525000,
                     'N118',340000,120000,
                     'N119',340000,165000,
                     'N120',340000,210000,
                     'N121',340000,255000,
                     'N122',340000,300000,
                     'N123',340000,345000,
                     'N124',340000,390000,
                     'N125',340000,435000,
                     'N126',340000,480000,
                     'N127',340000,525000,
                     'N128',310000,120000,
                     'N129',310000,165000,
                     'N130',310000,210000,
                     'N131',310000,255000,
                     'N132',310000,300000,
                     'N133',310000,345000,
                     'N134',310000,390000,
                     'N135',310000,435000,
                     'N136',280000,165000,
                     'N137',280000,210000,
                     'N138',280000,255000,
                     'N139',280000,300000,
                     'N140',280000,345000,
                     'N141',280000,390000,
                     'N142',280000,435000,
                     'N143',250000,255000,
                     'N144',250000,300000,
                     'N145',250000,345000,
                     'N146',250000,390000,
                     'N147',250000,435000,
                     'N148',220000,255000,
                     'N149',220000,300000,
                     'N150',220000,345000,
                     'N151',220000,390000,
                     'N152',190000,255000,
                     'N153',190000,300000,
                     'N154',190000,345000,
                     'N155',190000,390000,
                     'N156',160000,210000,
                     'N157',160000,255000,
                     'N158',160000,300000,
                     'N159',160000,345000,
                     'N160',130000,210000,
                     'N161',130000,255000,
                     'N162',130000,300000,
                     'N163',130000,345000,
                     'N164',100000,210000,
                     'N165',100000,255000,
                     'N166',100000,300000,
                     'N167',100000,345000,
                     'N168',70000,255000,
                     'N169',70000,30000,
                     'S001',920000,590000,
                     'S002',890000,545000,
                     'S003',890000,590000,
                     'S004',890000,635000,
                     'S005',890000,680000,
                     'S006',890000,725000,
                     'S007',860000,545000,
                     'S008',860000,590000,
                     'S009',860000,635000,
                     'S010',860000,680000,
                     'S011',860000,725000,
                     'S012',830000,545000,
                     'S013',830000,590000,
                     'S014',830000,635000,
                     'S015',830000,680000,
                     'S016',830000,725000,
                     'S017',800000,500000,
                     'S018',800000,545000,
                     'S019',800000,590000,
                     'S020',800000,635000,
                     'S021',800000,680000,
                     'S022',800000,725000,
                     'S023',770000,455000,
                     'S024',770000,500000,
                     'S025',770000,545000,
                     'S026',770000,590000,
                     'S027',770000,635000,
                     'S028',770000,680000,
                     'S029',770000,725000,
                     'S030',740000,455000,
                     'S031',740000,500000,
                     'S032',740000,545000,
                     'S033',740000,590000,
                     'S034',740000,635000,
                     'S035',740000,680000,
                     'S036',740000,725000,
                     'S037',710000,455000,
                     'S038',710000,500000,
                     'S039',710000,545000,
                     'S040',710000,590000,
                     'S041',710000,635000,
                     'S042',710000,680000,
                     'S043',710000,725000,
                     'S044',680000,455000,
                     'S045',680000,500000,
                     'S046',680000,545000,
                     'S047',680000,590000,
                     'S048',680000,635000,
                     'S049',680000,680000,
                     'S050',650000,410000,
                     'S051',650000,455000,
                     'S052',650000,500000,
                     'S053',650000,545000,
                     'S054',650000,590000,
                     'S055',650000,635000,
                     'S056',650000,680000,
                     'S057',620000,410000,
                     'S058',620000,455000,
                     'S059',620000,500000,
                     'S060',620000,545000,
                     'S061',620000,590000,
                     'S062',620000,635000,
                     'S063',590000,365000,
                     'S064',590000,410000,
                     'S065',590000,455000,
                     'S066',590000,500000,
                     'S067',590000,545000,
                     'S068',590000,590000,
                     'S069',590000,635000,
                     'S070',560000,320000,
                     'S071',560000,365000,
                     'S072',560000,410000,
                     'S073',560000,455000,
                     'S074',560000,500000,
                     'S075',560000,545000,
                     'S076',560000,590000,
                     'S077',530000,275000,
                     'S078',530000,320000,
                     'S079',530000,365000,
                     'S080',530000,410000,
                     'S081',530000,455000,
                     'S082',530000,500000,
                     'S083',530000,545000,
                     'S084',530000,590000,
                     'S085',530000,635000,
                     'S086',500000,230000,
                     'S087',500000,275000,
                     'S088',500000,320000,
                     'S089',500000,365000,
                     'S090',500000,410000,
                     'S091',500000,455000,
                     'S092',500000,500000,
                     'S093',500000,545000,
                     'S094',500000,590000,
                     'S095',500000,635000,
                     'S096',470000,185000,
                     'S097',470000,230000,
                     'S098',470000,275000,
                     'S099',470000,320000,
                     'S100',470000,365000,
                     'S101',470000,410000,
                     'S102',470000,455000,
                     'S103',470000,500000,
                     'S104',440000,140000,
                     'S105',440000,185000,
                     'S106',440000,230000,
                     'S107',440000,275000,
                     'S108',440000,320000,
                     'S109',440000,365000,
                     'S110',440000,410000,
                     'S111',440000,455000,
                     'S112',410000,140000,
                     'S113',410000,185000,
                     'S114',410000,230000,
                     'S115',410000,275000,
                     'S116',410000,320000,
                     'S117',410000,365000,
                     'S118',410000,410000,
                     'S119',410000,455000,
                     'S120',380000,95000,
                     'S121',380000,140000,
                     'S122',380000,185000,
                     'S123',380000,230000,
                     'S124',380000,275000,
                     'S125',380000,320000,
                     'S126',380000,365000,
                     'S127',380000,410000,
                     'S128',380000,455000,
                     'S129',350000,95000,
                     'S130',350000,140000,
                     'S131',350000,185000,
                     'S132',350000,230000,
                     'S133',350000,275000,
                     'S134',350000,320000,
                     'S135',350000,365000,
                     'S136',350000,410000,
                     'S137',350000,455000,
                     'S138',320000,50000,
                     'S139',320000,95000,
                     'S140',320000,140000,
                     'S141',320000,185000,
                     'S142',320000,230000,
                     'S143',320000,275000,
                     'S144',320000,320000,
                     'S145',320000,365000,
                     'S146',320000,410000,
                     'S147',290000,50000,
                     'S148',290000,95000,
                     'S149',290000,140000,
                     'S150',290000,185000,
                     'S151',290000,230000,
                     'S152',290000,275000,
                     'S153',290000,320000,
                     'S154',290000,365000,
                     'S155',290000,410000,
                     'S156',260000,50000,
                     'S157',260000,95000,
                     'S158',260000,140000,
                     'S159',260000,185000,
                     'S160',260000,230000,
                     'S161',260000,275000,
                     'S162',260000,320000,
                     'S163',260000,365000,
                     'S164',260000,410000,
                     'S165',230000,50000,
                     'S166',230000,95000,
                     'S167',230000,140000,
                     'S168',230000,185000,
                     'S169',230000,230000,
                     'S170',230000,275000,
                     'S171',230000,320000,
                     'S172',230000,365000,
                     'S173',200000,50000,
                     'S174',200000,95000,
                     'S175',200000,140000,
                     'S176',200000,185000,
                     'S177',200000,230000,
                     'S178',200000,275000,
                     'S179',200000,320000,
                     'S180',200000,365000,
                     'S181',170000,185000,
                     'S182',170000,230000,
                     'S183',170000,275000,
                     'S184',170000,320000,
                     'S185',140000,140000,
                     'S186',140000,185000,
                     'S187',140000,230000,
                     'S188',110000,140000,
                     'S189',110000,185000,
                     'S190',80000,140000,
                     'S191',80000,18500)

#Convert map references to yard grid
MapRefCoords2 <- MapRefCoords%>%
  separate("MapRef", c("Sheet","MapRefEast","MapRefNorth"),  sep = c(4,7), remove = FALSE, convert = TRUE, extra = "merge")%>%
  separate("MapRef", c("Island","SheetNo","ChrMapRefEast","ChrMapRefNorth"),  sep = c(1,4,7), remove = FALSE, convert = FALSE, extra = "merge")%>%
  mutate(LINZ_format = paste0(Island,as.integer(SheetNo)," ",ChrMapRefEast," ",ChrMapRefNorth))%>%
  left_join(MapSheets, by = c("Sheet"))%>%
  mutate(EastYard = ifelse(round(floor(SheetEast*10^-5)/10^-5, digits = 0)+MapRefEast*100<SheetEast,round(floor(SheetEast*10^-5)/10^-5, digits = 0)+MapRefEast*100+100000,round(floor(SheetEast*10^-5)/10^-5, digits = 0)+MapRefEast*100))%>%
  mutate(NorthYard = ifelse(round(floor(SheetNorth*10^-5)/10^-5, digits = 0)+MapRefNorth*100<SheetNorth,round(floor(SheetNorth*10^-5)/10^-5, digits = 0)+MapRefNorth*100+100000,round(floor(SheetNorth*10^-5)/10^-5, digits = 0)+MapRefNorth*100))

#Select base CRS to use
BaseCRS <- NZTM

#Select North Island coordinates and convert to WGS84
NIMapRefCoords <- MapRefCoords2%>%
  filter(Island=="N")%>%
  st_as_sf(coords=c("EastYard", "NorthYard"), crs=NIYG, remove=FALSE)%>%
  st_transform(crs=BaseCRS)

#Select South Island coordinates and convert to WGS84
SIMapRefCoords <- MapRefCoords2%>%
  filter(Island=="S")%>%
  st_as_sf(coords=c("EastYard", "NorthYard"), crs=SIYG, remove=FALSE)%>%
  st_transform(crs=BaseCRS)

#Merge back to single dataset
ConvertedCoords <- NIMapRefCoords%>%
  bind_rows(SIMapRefCoords)%>%
  select(MapRef, LINZ_format, geometry)

#Load TLA boundaries
TLA <- read_sf("C:/Users/EdwardsP/OneDrive - DairyNZ Limited/GIS/Kellogg/TLA(incAKL).shp")
TLA <- st_transform(TLA, crs=BaseCRS)
TLA <- mutate(TLA, Location = paste0(NAME_2, " ", TYPE_2, ", ", NAME_1))

#Plot points for visual check
ggplot() +
  geom_sf(data=TLA, aes())+
  geom_sf(data=ConvertedCoords, aes())

#Determine TLA
i <- as.integer(st_within(ConvertedCoords, TLA))
ConvertedCoords$Location <- TLA$Location[i]

#Export csv
write_csv(ConvertedCoords, file="ConvertedCoords.csv")

